From 1de932b5fa8de2d99be094b25a5e878ad740f94d Mon Sep 17 00:00:00 2001
From: LawrenceSY_Kuo <LawrenceSY_Kuo@asus.com>
Date: Fri, 5 Aug 2016 10:18:08 +0800
Subject: [PATCH] VK: sysfs for current state, correct the thresholds for
 sensor 2

Change-Id: I1d98edcf0d5660209ac434cdeef7072a80979fba
---
 drivers/input/keyboard/cap12LF1552.c |   19 ++++++++++++-------
 1 file changed, 12 insertions(+), 7 deletions(-)

diff --git a/drivers/input/keyboard/cap12LF1552.c b/drivers/input/keyboard/cap12LF1552.c
index 260df476..a12e29c 100644
--- a/drivers/input/keyboard/cap12LF1552.c
+++ b/drivers/input/keyboard/cap12LF1552.c
@@ -29,7 +29,7 @@ DEVICE_ATTR(calibration, 0644, show_attrs_handler, NULL);
 DEVICE_ATTR(addititonal_sample_cap_selection_2, 0644, show_attrs_handler, store_attrs_handler);
 DEVICE_ATTR(acquisition, 0644, show_attrs_handler, store_attrs_handler);
 DEVICE_ATTR(precharge, 0644, show_attrs_handler, store_attrs_handler);
-DEVICE_ATTR(version, 0644, show_attrs_handler, NULL);
+DEVICE_ATTR(state, 0644, show_attrs_handler, NULL);
 
 static struct attribute *cap12LF1552_attrs[] = {
     &dev_attr_virtual_keys.attr,
@@ -47,7 +47,7 @@ static struct attribute *cap12LF1552_attrs[] = {
     &dev_attr_calibration.attr,
     &dev_attr_acquisition.attr,
     &dev_attr_precharge.attr,
-    &dev_attr_version.attr,
+    &dev_attr_state.attr,
     NULL
 };
 
@@ -184,7 +184,7 @@ static void cap12LF1552_music_settings(struct work_struct *work) {
             cap12LF1552_write_reg(data->client, SAMPLE_CONFIG, 0x0A);
             current_samples = 0x0A;
             cap12LF1552_write_reg(data->client, SENSOR1_THRESHOLD, 0x96);
-            cap12LF1552_write_reg(data->client, SENSOR1_THRESHOLD, 0x96);
+            cap12LF1552_write_reg(data->client, SENSOR2_THRESHOLD, 0x96);
             if (!calibration) {
                 calibration = 1;
                 schedule_delayed_work(&data->calibration_work, msecs_to_jiffies(5000));
@@ -195,7 +195,7 @@ static void cap12LF1552_music_settings(struct work_struct *work) {
             cap12LF1552_write_reg(data->client, SAMPLE_CONFIG, 0x07);
             current_samples = 0x07;
             cap12LF1552_write_reg(data->client, SENSOR1_THRESHOLD, 0xA2);
-            cap12LF1552_write_reg(data->client, SENSOR1_THRESHOLD, 0xA2);
+            cap12LF1552_write_reg(data->client, SENSOR2_THRESHOLD, 0xA2);
             if (!calibration) {
                 calibration = 1;
                 schedule_delayed_work(&data->calibration_work, msecs_to_jiffies(5000));
@@ -347,10 +347,15 @@ static ssize_t show_attrs_handler(struct device *dev,
         ret = cap12LF1552_read_reg(client, 0x0C);
         mutex_unlock(&cap_mtx);
         return snprintf(buf, 8, "0x%02X\n", ret);
-    } else if (!strcmp(attr_name, dev_attr_version.attr.name)) {
-        ret = cap12LF1552_read_reg(client, 0x22);
+    } else if (!strcmp(attr_name, dev_attr_state.attr.name)) {
+        ret = current_state;
         mutex_unlock(&cap_mtx);
-        return snprintf(buf, 8, "0x%02X\n", ret);
+        if (ret == NORMAL)
+            return snprintf(buf, 14, "Normal\n");
+        else if (ret == WORKAROUND1)
+            return snprintf(buf, 14, "Workaround 1\n");
+        else if (ret == WORKAROUND2)
+            return snprintf(buf, 14, "Workaround 2\n");
     } else if (!strcmp(attr_name, dev_attr_background_noise.attr.name)) {
         ret = cap12LF1552_read_reg(client, 0x09);
         mutex_unlock(&cap_mtx);
-- 
1.7.9.5

